# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
- main

pool:
  name: MPSS Common

variables:
  buildConfiguration: 'Release'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '6.0.x'
    includePreviewVersions: true

# NuGet tool installer
# Acquires a specific version of NuGet from the internet or the tools cache and adds it to the PATH. Use this task to change the version of NuGet used in the NuGet tasks.
- task: NuGetToolInstaller@1
  inputs:
    versionSpec: 6.1.0
    checkLatest: false

#- task: DotNetCoreCLI@2
#  inputs:
#    command: 'restore'
#    projects: 'DomainServices\UserService\Api\DomainServices.UserService.Api.csproj'
#    feedsToUse: 'config'
#    nugetConfigPath: 'C:\Users\XX_TFSAGENT_MPSS\AppData\Roaming\NuGet\NuGet.Config'
#    noCache: true

- task: NuGetCommand@2
  inputs:
    command: 'restore'
    restoreSolution: 'DomainServices\UserService\Api\DomainServices.UserService.Api.csproj'
    feedsToUse: 'config'
    nugetConfigPath: 'C:\Users\XX_TFSAGENT_MPSS\AppData\Roaming\NuGet\NuGet.Config'
    noCache: true

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: 'DomainServices\UserService\Api\DomainServices.UserService.Api.csproj'
    arguments: '--output $(Build.BinariesDirectory) --no-restore'


- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.BinariesDirectory)'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/UserService_$(Build.BuildNumber).zip'
    replaceExistingArchive: true

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/UserService_$(Build.BuildNumber).zip'
    ArtifactName: 'drop'
    publishLocation: 'FilePath'
    TargetPath: '\\sapckb079\NETDEV\BuildsMPSS\DomainServices\'